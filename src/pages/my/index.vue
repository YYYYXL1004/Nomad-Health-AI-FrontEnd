<template>
  <view class="container">
    <!-- È°∂ÈÉ®Áî®Êà∑‰ø°ÊÅØ -->
    <view class="user-info-section">
      <view class="user-avatar">
        <image 
          :src="userInfo.avatar || '/src/static/images/default-avatar.jpg'" 
          mode="aspectFill"
        ></image>
      </view>
      <view class="user-details">
        <text class="user-name">{{ userInfo.username || 'Ê∏∏ÂÆ¢' }}</text>
        <text class="user-id">ID: {{ userInfo.userId || '--' }}</text>
      </view>
      <view class="edit-btn" @tap="editProfile">
        <text>{{ $t('my.editProfile') }}</text>
      </view>
    </view>
    
    <!-- ËØ¶ÁªÜ‰ø°ÊÅØÂ±ïÁ§∫Âå∫ -->
    <view v-if="showDetailInfo" class="detail-info-section">
      <view class="detail-item" v-if="userInfo.phone">
        <text class="detail-label">{{ $t('my.phoneLabel') }}</text>
        <text class="detail-value">{{ userInfo.phone }}</text>
      </view>
      <view class="detail-item" v-if="userInfo.gender">
        <text class="detail-label">{{ $t('my.genderLabel') }}</text>
        <text class="detail-value">{{ 
          userInfo.gender === 'male' ? $t('my.male') : 
          userInfo.gender === 'female' ? $t('my.female') : $t('my.unset') 
        }}</text>
      </view>
      <view class="detail-item" v-if="userInfo.birthday">
        <text class="detail-label">{{ $t('my.birthdayLabel') }}</text>
        <text class="detail-value">{{ userInfo.birthday || $t('my.unset') }}</text>
      </view>
      <view class="detail-item" v-if="userInfo.height">
        <text class="detail-label">{{ $t('my.heightLabel') }}</text>
        <text class="detail-value">{{ userInfo.height ? userInfo.height + ' cm' : $t('my.unset') }}</text>
      </view>
      <view class="detail-item" v-if="userInfo.weight">
        <text class="detail-label">{{ $t('my.weightLabel') }}</text>
        <text class="detail-value">{{ userInfo.weight ? userInfo.weight + ' kg' : $t('my.unset') }}</text>
      </view>
      <view class="detail-item" v-if="userInfo.email">
        <text class="detail-label">{{ $t('my.emailLabel') }}</text>
        <text class="detail-value">{{ userInfo.email || $t('my.unset') }}</text>
      </view>
      <view class="detail-item" v-if="userInfo.address">
        <text class="detail-label">{{ $t('my.addressLabel') }}</text>
        <text class="detail-value">{{ userInfo.address || $t('my.unset') }}</text>
      </view>
      <view class="detail-item" v-if="userInfo.created_at">
        <text class="detail-label">{{ $t('my.registerTimeLabel') }}</text>
        <text class="detail-value">{{ userInfo.created_at }}</text>
      </view>
      <view class="detail-toggle" @tap="showDetailInfo = false">
        <text>{{ $t('my.collapseInfo') }}</text>
      </view>
    </view>
    <view v-else class="detail-toggle" @tap="showDetailInfo = true">
      <text>{{ $t('my.viewMoreInfo') }}</text>
    </view>
    
    <!-- ÂäüËÉΩËèúÂçï -->
    <view class="menu-section">
      <view class="menu-title">
        <text>{{ $t('my.healthServices') }}</text>
      </view>
      <view class="menu-list">
        <view class="menu-item" @tap="navigateTo('/pages/my/health-records')">
          <view class="menu-icon health-icon">üìã</view>
          <view class="menu-info">
            <text class="menu-name">{{ $t('my.healthRecords') }}</text>
          </view>
          <text class="menu-arrow">></text>
        </view>
        
        <view class="menu-item" @tap="navigateTo('/pages/my/consultations')">
          <view class="menu-icon consultation-icon">üí¨</view>
          <view class="menu-info">
            <text class="menu-name">{{ $t('my.consultHistory') }}</text>
          </view>
          <text class="menu-arrow">></text>
        </view>
        
        <view class="menu-item" @tap="navigateTo('/pages/my/prescriptions')">
          <view class="menu-icon prescription-icon">üíä</view>
          <view class="menu-info">
            <text class="menu-name">{{ $t('my.prescriptions') }}</text>
          </view>
          <text class="menu-arrow">></text>
        </view>
      </view>
    </view>
    
    <!-- ËÆæÁΩÆËèúÂçï -->
    <view class="menu-section">
      <view class="menu-title">
        <text>{{ $t('settings.title') }}</text>
      </view>
      <view class="menu-list">
        <view class="menu-item" @tap="navigateTo('/pages/my/settings')">
          <view class="menu-icon settings-icon">‚öôÔ∏è</view>
          <view class="menu-info">
            <text class="menu-name">{{ $t('my.appSettings') }}</text>
          </view>
          <text class="menu-arrow">></text>
        </view>
        
        <view class="menu-item" @tap="logout">
          <view class="menu-icon logout-icon">üîì</view>
          <view class="menu-info">
            <text class="menu-name">{{ $t('auth.logout') }}</text>
          </view>
          <text class="menu-arrow">></text>
        </view>
      </view>
    </view>
    
    <!-- Â∫ïÈÉ®ÁâàÊú¨‰ø°ÊÅØ -->
    <view class="version-info">
      <text>{{ $t('my.version') }}: 1.0.0</text>
    </view>
    
    <!-- ‰ΩøÁî®ÈÄöÁî®Â∫ïÈÉ®ÂØºËà™Ê†èÁªÑ‰ª∂ -->
    <custom-tab-bar active="my" />
  </view>
</template>

<script setup>
import { ref, onMounted, onActivated, onBeforeUnmount } from 'vue';
import { getCurrentLang } from '@/i18n/index.js';
import CustomTabBar from '@/components/CustomTabBar.vue';
import { userApi, authApi } from '@/api/index.js';
import { getAppInstance } from '@/utils/platform.js';

// ÂΩìÂâçËØ≠Ë®Ä
const currentLang = ref(getCurrentLang());

// Áî®Êà∑‰ø°ÊÅØ
const userInfo = ref({
  userId: '',
  account: '',
  username: '',
  nickname: '',
  avatar: '',
  phone: '',
  gender: '',
  birthday: null,
  height: 0,
  weight: 0,
  email: '',
  address: '',
  created_at: ''
});

// ËØ¶ÁªÜ‰ø°ÊÅØÂ±ïÁ§∫ÊéßÂà∂
const showDetailInfo = ref(false);

// È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
onMounted(() => {
  fetchUserInfo();
});

// È°µÈù¢ÊøÄÊ¥ªÊó∂ÈáçÊñ∞Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÔºàÂ¶Ç‰ªéÂÖ∂‰ªñÈ°µÈù¢ËøîÂõûÔºâ
onActivated(() => {
  console.log('ÊàëÁöÑÈ°µÈù¢Ë¢´ÊøÄÊ¥ªÔºåÈáçÊñ∞Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ');
  fetchUserInfo();
});

// Ê∑ªÂä†È°µÈù¢ÊòæÁ§∫ÁöÑ‰∫ã‰ª∂ÁõëÂê¨
uni.$on('updateUserInfo', () => {
  console.log('Êî∂Âà∞Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØÁöÑ‰∫ã‰ª∂ÔºåÂà∑Êñ∞Êï∞ÊçÆ');
  fetchUserInfo();
});

// ÁªÑ‰ª∂ÈîÄÊØÅÊó∂ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨
onBeforeUnmount(() => {
  uni.$off('updateUserInfo');
});

// Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
const fetchUserInfo = () => {
  // Ëé∑ÂèñÂ≠òÂÇ®ÁöÑÁî®Êà∑Âü∫Êú¨‰ø°ÊÅØ
  const storedInfo = uni.getStorageSync('userInfo');
  if (storedInfo) {
    userInfo.value = { ...userInfo.value, ...storedInfo };
    
    // Á°Æ‰øùÂ§¥ÂÉèË∑ØÂæÑÊ†ºÂºèÊ≠£Á°Æ
    if (userInfo.value.avatar && !userInfo.value.avatar.startsWith('http') && !userInfo.value.avatar.startsWith('/')) {
      // Â¶ÇÊûú‰∏çÊòØhttpÈìæÊé•ÊàñÁªùÂØπË∑ØÂæÑÔºåÂàô‰øÆÊ≠£Ê†ºÂºè
      userInfo.value.avatar = '/src/static/images/default-avatar.jpg';
    }
  }
  
  // Ë∞ÉÁî®APIËé∑ÂèñÂÆåÊï¥Áî®Êà∑‰ø°ÊÅØ
  userApi.getProfile().then(res => {
    if (res.data) {
      console.log('APIËøîÂõûÁöÑÁî®Êà∑‰ø°ÊÅØÔºö', res.data);
      
      // Â§ÑÁêÜÂ§¥ÂÉèURL
      let avatarUrl = res.data.avatar || userInfo.value.avatar || '/src/static/images/default-avatar.jpg';
      
      // Â¶ÇÊûúÂ§¥ÂÉèURLÊòØblobÊ†ºÂºèÔºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
      if (avatarUrl && (avatarUrl.startsWith('blob:') || avatarUrl === '')) {
        avatarUrl = '/src/static/images/default-avatar.jpg';
        console.log('‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉèË∑ØÂæÑ:', avatarUrl);
      }
      
      // ÂêàÂπ∂Êï∞ÊçÆÔºå‰øùÁïôÂ§¥ÂÉèÁ≠âÂ∑≤Êúâ‰ø°ÊÅØ
      userInfo.value = { 
        ...userInfo.value,
        ...res.data,
        avatar: avatarUrl,
        // Á°Æ‰øù‰ΩøÁî®nickname‰Ωú‰∏∫ÊòæÁ§∫ÂêçÁß∞
        username: res.data.nickname || res.data.account || userInfo.value.username || 'Ê∏∏ÂÆ¢'
      };
      
      // ÊâìÂç∞ÂÆåÊï¥ÁöÑÁî®Êà∑‰ø°ÊÅØÁî®‰∫éË∞ÉËØï
      console.log('ÂêàÂπ∂ÂêéÁöÑÂÆåÊï¥Áî®Êà∑‰ø°ÊÅØÔºö', userInfo.value);
      
      // Êõ¥Êñ∞Â≠òÂÇ®ÁöÑÁî®Êà∑‰ø°ÊÅØ - ‰øùÂ≠òÊâÄÊúâÂ≠óÊÆµ
      uni.setStorageSync('userInfo', {
        userId: res.data.userId,
        account: res.data.account,
        username: res.data.nickname || res.data.account,
        nickname: res.data.nickname,
        avatar: avatarUrl,
        phone: res.data.phone,
        gender: res.data.gender,
        birthday: res.data.birthday,
        height: res.data.height,
        weight: res.data.weight,
        email: res.data.email,
        address: res.data.address,
        created_at: res.data.created_at
      });
    }
  }).catch(err => {
    console.error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•', err);
    
    // Â¶ÇÊûúÊòØ401ÈîôËØØÔºàÊú™ÊéàÊùÉÔºâÔºåË∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µ
    if (err.code === 401) {
      uni.removeStorageSync('token');
      uni.removeStorageSync('userId');
      uni.removeStorageSync('userInfo');
      uni.removeStorageSync('isLoggedIn');
      
      uni.reLaunch({
        url: '/pages/login/index'
      });
    }
  });
};

// ÂØºËà™Âà∞ÂÖ∂‰ªñÈ°µÈù¢
const navigateTo = (url) => {
  uni.navigateTo({ url });
};

// ÁºñËæë‰∏™‰∫∫ËµÑÊñô
const editProfile = () => {
  uni.navigateTo({
    url: '/pages/my/edit-profile'
  });
};

// ÈÄÄÂá∫ÁôªÂΩï
const logout = () => {
  // ÊèêÁ§∫ÊñáÊú¨
  const logoutConfirmText = currentLang.value === 'zh' ? 'Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü' : '–¢–∞ —Å–∏—Å—Ç–µ–º—ç—ç—Å –≥–∞—Ä–∞—Ö–¥–∞–∞ –∏—Ç–≥—ç–ª—Ç—ç–π –±–∞–π–Ω–∞ —É—É?';
  
  uni.showModal({
    title: currentLang.value === 'zh' ? 'ÊèêÁ§∫' : '–ê–Ω—Ö–∞–∞—Ä—É—É–ª–≥–∞',
    content: logoutConfirmText,
    success: (res) => {
      if (res.confirm) {
        // ÊòæÁ§∫Âä†ËΩΩ‰∏≠
        uni.showLoading({
          title: currentLang.value === 'zh' ? 'ÈÄÄÂá∫‰∏≠...' : '–ì–∞—Ä—á –±–∞–π–Ω–∞...'
        });
        
        // Ë∞ÉÁî®ÁôªÂá∫API
        authApi.logout().then((res) => {
          console.log('ÈÄÄÂá∫ÁôªÂΩïÊàêÂäü:', res);
          uni.hideLoading();
          handleLogoutSuccess();
        }).catch(err => {
          console.error('ÈÄÄÂá∫ÁôªÂΩïÂ§±Ë¥•:', err);
          uni.hideLoading();
          // Âç≥‰ΩøAPIÂ§±Ë¥•Ôºå‰πüÂº∫Âà∂Ê∏ÖÈô§Êú¨Âú∞Â≠òÂÇ®Âπ∂Ë∑≥ËΩ¨
          handleLogoutSuccess();
        });
      }
    }
  });
};

// Â§ÑÁêÜÈÄÄÂá∫ÁôªÂΩïÊàêÂäü
const handleLogoutSuccess = () => {
  // Ê∏ÖÈô§Êú¨Âú∞Â≠òÂÇ®ÁöÑÁî®Êà∑‰ø°ÊÅØÂíåtoken
  uni.removeStorageSync('token');
  uni.removeStorageSync('userId');
  uni.removeStorageSync('userInfo');
  uni.removeStorageSync('isLoggedIn');
          
  // ÊòæÁ§∫ÊèêÁ§∫
  const logoutSuccessText = currentLang.value === 'zh' ? 'ÈÄÄÂá∫ÁôªÂΩïÊàêÂäü' : '–°–∏—Å—Ç–µ–º—ç—ç—Å –∞–º–∂–∏–ª—Ç—Ç–∞–π –≥–∞—Ä–ª–∞–∞';
  
  uni.showToast({
    title: logoutSuccessText,
    icon: 'success',
    duration: 1500
  });
  
  // Âª∂ËøüË∑≥ËΩ¨ÔºåÁ≠âÂæÖÊèêÁ§∫ÊòæÁ§∫ÂÆåÊØï
  setTimeout(() => {
    // ‰ΩøÁî®reLaunchÁ°Æ‰øùÂÆåÂÖ®Âà∑Êñ∞È°µÈù¢
    uni.reLaunch({
      url: '/pages/login/index'
    });
  }, 1500);
};
</script>

<style>
.container {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  background-color: #f5f5f5;
  padding-bottom: 120rpx; /* ‰∏∫Â∫ïÈÉ®ÂØºËà™ÁïôÂá∫Á©∫Èó¥ */
}

/* Áî®Êà∑‰ø°ÊÅØÂå∫Âüü */
.user-info-section {
  display: flex;
  align-items: center;
  padding: 40rpx 30rpx;
  background-color: #8ab6c8;
  color: #fff;
}

.user-avatar {
  width: 120rpx;
  height: 120rpx;
  border-radius: 60rpx;
  overflow: hidden;
  margin-right: 30rpx;
  border: 4rpx solid rgba(255, 255, 255, 0.6);
  background-color: #ffffff; /* Ê∑ªÂä†ËÉåÊôØËâ≤ */
}

.user-avatar image {
  width: 100%;
  height: 100%;
  object-fit: cover; /* Á°Æ‰øùÂõæÁâáÂ°´Êª°ÂÆπÂô® */
}

.user-details {
  flex: 1;
}

.user-name {
  font-size: 36rpx;
  font-weight: bold;
  margin-bottom: 10rpx;
}

.user-id {
  font-size: 24rpx;
  opacity: 0.8;
}

.edit-btn {
  padding: 12rpx 24rpx;
  background-color: rgba(255, 255, 255, 0.3);
  border-radius: 30rpx;
}

.edit-btn text {
  font-size: 24rpx;
  color: #fff;
}

/* ËèúÂçïÂå∫Âüü */
.menu-section {
  margin: 30rpx 30rpx 0;
  background-color: #fff;
  border-radius: 16rpx;
  overflow: hidden;
  box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);
}

.menu-title {
  padding: 20rpx 30rpx;
  border-bottom: 1rpx solid #f0f0f0;
}

.menu-title text {
  font-size: 30rpx;
  font-weight: bold;
  color: #333;
}

.menu-list {
  padding: 0 30rpx;
}

.menu-item {
  display: flex;
  align-items: center;
  padding: 30rpx 0;
  border-bottom: 1rpx solid #f0f0f0;
}

.menu-item:last-child {
  border-bottom: none;
}

.menu-icon {
  width: 60rpx;
  height: 60rpx;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 36rpx;
  margin-right: 20rpx;
}

.menu-info {
  flex: 1;
}

.menu-name {
  font-size: 28rpx;
  color: #333;
  margin-bottom: 6rpx;
}

.menu-desc {
  font-size: 24rpx;
  color: #999;
}

.menu-arrow {
  font-size: 30rpx;
  color: #ccc;
}

/* Â∫ïÈÉ®ÁâàÊú¨‰ø°ÊÅØ */
.version-info {
  padding: 40rpx 0;
  text-align: center;
}

.version-info text {
  font-size: 24rpx;
  color: #999;
}

/* ËØ¶ÁªÜ‰ø°ÊÅØÂ±ïÁ§∫Âå∫ */
.detail-info-section {
  padding: 20rpx 30rpx;
  background-color: #fff;
  border-radius: 16rpx;
  overflow: hidden;
  box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);
}

.detail-item {
  margin-bottom: 20rpx;
}

.detail-label {
  font-size: 28rpx;
  font-weight: bold;
  color: #333;
}

.detail-value {
  font-size: 24rpx;
  color: #666;
}

.detail-toggle {
  padding: 20rpx 30rpx;
  text-align: center;
  background-color: #f0f0f0;
  border-radius: 16rpx;
  margin: 20rpx 30rpx;
}

.detail-toggle text {
  font-size: 24rpx;
  color: #333;
}
</style> 